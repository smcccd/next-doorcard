name: Enhanced CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip tests (use with caution)"
        required: false
        default: false
        type: boolean

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22"
  CYPRESS_CACHE_FOLDER: ~/.cache/Cypress
  NEXT_TELEMETRY_DISABLED: 1
  # Timeouts
  DEFAULT_TIMEOUT: 10
  BUILD_TIMEOUT: 15
  E2E_TIMEOUT: 20
  DEPLOY_TIMEOUT: 10

jobs:
  # First, check if we should run the pipeline
  check-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      deps: ${{ steps.filter.outputs.deps }}
      prisma: ${{ steps.filter.outputs.prisma }}
      tests: ${{ steps.filter.outputs.tests }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - '**/*.ts'
              - '**/*.tsx'
              - '**/*.js'
              - '**/*.jsx'
              - '**/*.json'
              - '!**/*.test.*'
              - '!**/*.spec.*'
            deps:
              - 'package.json'
              - 'package-lock.json'
            prisma:
              - 'prisma/**'
            tests:
              - '**/*.test.*'
              - '**/*.spec.*'
              - 'cypress/**'
              - 'jest.config.js'
            docs:
              - '**/*.md'
              - 'docs/**'

  # Setup job with enhanced caching
  setup:
    name: Setup & Dependencies
    runs-on: ubuntu-latest
    needs: check-changes
    if: ${{ needs.check-changes.outputs.code == 'true' || needs.check-changes.outputs.deps == 'true' || needs.check-changes.outputs.tests == 'true' || github.event.inputs.skip_tests != 'true' }}
    timeout-minutes: ${{ env.DEFAULT_TIMEOUT }}
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate cache key
        id: cache-key
        run: |
          echo "key=${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      # Enhanced multi-layer caching
      - name: Cache dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
            ~/.cache/Cypress
            ~/.cache/prisma
            node_modules/.prisma
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          npm ci --prefer-offline --no-audit --progress=false
          npx cypress install
          npx cypress verify

      - name: Validate installation
        run: |
          npm ls --depth=0
          npx cypress info
          npx prisma --version

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: |
            package-lock.json
            npm-shrinkwrap.json
          retention-days: 30

  # Parallel static analysis
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: [setup, check-changes]
    if: ${{ needs.check-changes.outputs.code == 'true' || needs.check-changes.outputs.tests == 'true' }}
    timeout-minutes: ${{ env.DEFAULT_TIMEOUT }}
    strategy:
      fail-fast: false
      matrix:
        check: [lint, format, typecheck]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
            ~/.cache/prisma
            node_modules/.prisma
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Generate Prisma client
        if: matrix.check == 'typecheck'
        run: npx prisma generate

      - name: Run ${{ matrix.check }}
        run: |
          case "${{ matrix.check }}" in
            lint)
              npm run lint -- --max-warnings=0
              ;;
            format)
              npm run format:check
              ;;
            typecheck)
              npm run type-check
              ;;
          esac

      - name: Report results
        if: failure()
        run: |
          echo "::error::${{ matrix.check }} check failed"
          echo "Please run 'npm run ${{ matrix.check }}:fix' locally to fix issues"

  # Security scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: ${{ env.DEFAULT_TIMEOUT }}
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run npm audit
        run: npm audit --production --audit-level=high

      - name: Run license check
        run: npx license-checker --production --summary --excludePrivatePackages

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # Unit and integration tests with database
  test-unit:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: [setup, static-analysis]
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    timeout-minutes: ${{ env.DEFAULT_TIMEOUT }}
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: nextdoorcard_test
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          --name=postgres
        ports:
          - 5432:5432
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
            ~/.cache/prisma
            node_modules/.prisma
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Setup test database
        run: |
          npx prisma generate
          npx prisma db push --skip-generate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nextdoorcard_test

      - name: Run tests with coverage
        run: npm run test:ci -- --coverage --coverageReporters=json,lcov,text,clover
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nextdoorcard_test
          NEXTAUTH_SECRET: test-secret
          NEXTAUTH_URL: http://localhost:3000

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unit
          fail_ci_if_error: false

      - name: Check coverage thresholds
        run: |
          npx nyc check-coverage --lines 70 --functions 70 --branches 60

  # Build application with caching
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [setup, static-analysis]
    timeout-minutes: ${{ env.BUILD_TIMEOUT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
            ~/.cache/prisma
            node_modules/.prisma
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Restore Next.js cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build application
        run: |
          npm run build:production
          # Verify build output
          if [ ! -d ".next" ]; then
            echo "::error::Build failed - .next directory not found"
            exit 1
          fi
        env:
          NODE_ENV: production
          CI: true

      - name: Analyze bundle size
        run: |
          npx next-bundle-analyzer @next/bundle-analyzer -c next.config.js
          echo "Bundle analysis complete"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .next
            public
            package.json
            package-lock.json
            next.config.js
          retention-days: 1
          include-hidden-files: true

  # E2E tests with enhanced parallelization
  test-e2e:
    name: E2E Tests (Shard ${{ matrix.shard }}/${{ strategy.job-total }})
    runs-on: ubuntu-latest
    needs: [build, test-unit]
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    timeout-minutes: ${{ env.E2E_TIMEOUT }}
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
            ~/.cache/Cypress
            ~/.cache/prisma
            node_modules/.prisma
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Prepare E2E environment
        run: |
          npx prisma generate
          # Create .env.local for E2E tests
          cat > .env.local << EOF
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          NEXTAUTH_URL=http://localhost:3000
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          ONELOGIN_CLIENT_ID=${{ secrets.ONELOGIN_CLIENT_ID }}
          ONELOGIN_CLIENT_SECRET=${{ secrets.ONELOGIN_CLIENT_SECRET }}
          ONELOGIN_ISSUER=${{ secrets.ONELOGIN_ISSUER }}
          CYPRESS=true
          EOF

      - name: Run E2E tests
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          headed: false
          start: npm run start
          wait-on: "http://localhost:3000/api/health"
          wait-on-timeout: 120
          config: |
            video=true
            screenshotOnRunFailure=true
            experimentalMemoryManagement=true
          spec: |
            cypress/e2e/**/*.cy.ts
          env: |
            SPLIT=${{ strategy.job-total }}
            SPLIT_INDEX=${{ matrix.shard }}
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload E2E artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts-shard-${{ matrix.shard }}
          path: |
            cypress/screenshots
            cypress/videos
            cypress/logs
          retention-days: 7

  # Deployment with health checks
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, test-unit, test-e2e]
    if: |
      github.ref == 'refs/heads/main' && 
      github.event_name == 'push' &&
      !contains(github.event.head_commit.message, '[skip deploy]')
    timeout-minutes: ${{ env.DEPLOY_TIMEOUT }}
    environment:
      name: production
      url: https://next-doorcard.vercel.app
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup deployment
        id: deployment
        run: |
          echo "deployment_id=${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: Deploy to Vercel
        id: vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod --force"
          scope: ${{ secrets.VERCEL_ORG_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-comment: false
          alias-domains: |
            next-doorcard-{{BRANCH}}.vercel.app

      - name: Verify deployment
        run: |
          echo "Deployment URL: ${{ steps.vercel.outputs.preview-url }}"
          # Wait for deployment to be ready
          sleep 30
          # Health check
          for i in {1..5}; do
            if curl -f -s -o /dev/null -w "%{http_code}" "${{ steps.vercel.outputs.preview-url }}/api/health" | grep -q "200"; then
              echo "Deployment health check passed"
              break
            elif [ $i -eq 5 ]; then
              echo "::error::Deployment health check failed after 5 attempts"
              exit 1
            else
              echo "Health check attempt $i failed, retrying in 10s..."
              sleep 10
            fi
          done

      - name: Run smoke tests
        run: |
          # Basic smoke test
          curl -f "${{ steps.vercel.outputs.preview-url }}" || exit 1
          curl -f "${{ steps.vercel.outputs.preview-url }}/api/health" || exit 1

      - name: Create deployment record
        if: success()
        run: |
          echo "Deployment ${{ steps.deployment.outputs.deployment_id }} successful"
          echo "Deployed at: ${{ steps.deployment.outputs.timestamp }}"
          echo "URL: ${{ steps.vercel.outputs.preview-url }}"

  # Summary and notifications
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [static-analysis, test-unit, test-e2e, build, deploy]
    if: always()
    steps:
      - name: Check job statuses
        id: status
        run: |
          echo "static_analysis=${{ needs.static-analysis.result }}" >> $GITHUB_OUTPUT
          echo "unit_tests=${{ needs.test-unit.result }}" >> $GITHUB_OUTPUT
          echo "e2e_tests=${{ needs.test-e2e.result }}" >> $GITHUB_OUTPUT
          echo "build=${{ needs.build.result }}" >> $GITHUB_OUTPUT
          echo "deploy=${{ needs.deploy.result }}" >> $GITHUB_OUTPUT

      - name: Create summary
        run: |
          echo "## Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Static Analysis | ${{ steps.status.outputs.static_analysis }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ steps.status.outputs.unit_tests }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ steps.status.outputs.e2e_tests }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.status.outputs.build }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ steps.status.outputs.deploy }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Send notifications
        if: failure() && github.ref == 'refs/heads/main'
        run: |
          echo "::error::Pipeline failed! Check the summary for details."
          # Add your notification logic here (Slack, email, etc.)

      - name: Create issue on failure
        if: failure() && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `CI/CD Pipeline Failure - Run #${context.runNumber}`;
            const body = `
            ## Pipeline Failure Report

            **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Branch:** ${context.ref}
            **Commit:** ${context.sha}
            **Triggered by:** ${context.actor}

            ### Failed Jobs:
            ${Object.entries(${{ toJson(steps.status.outputs) }})
              .filter(([_, status]) => status === 'failure')
              .map(([job, _]) => `- ${job}`)
              .join('\n')}

            Please investigate and fix the issues.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['ci-failure', 'automated']
            });
